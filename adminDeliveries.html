<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deliveries · Admin · Esuo's Beauty Empire</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --ink:#18120e;--cream:#faf7f3;--parchment:#f1ebe2;--sand:#e2d8cc;
      --warm-mid:#c9b49a;--gold:#a8854e;--gold-light:#c9a86c;--blush:#c8968a;
      --white:#fff;--muted:#7a6e65;--subtle:#9e9087;--card:#fffcf8;
      --border:#ede4d8;--danger:#c0392b;--success:#27855c;
      --sidebar-w:240px;--nav-h:60px;
      --r-sm:8px;--r-md:14px;--r-lg:24px;--r-xl:60px;
      --sh-xs:0 1px 4px rgba(24,18,14,.06);--sh-sm:0 4px 16px rgba(24,18,14,.08);
      --sh-md:0 10px 40px rgba(24,18,14,.12);--sh-lg:0 24px 64px rgba(24,18,14,.16);
      --ease:cubic-bezier(.4,0,.2,1);--spring:cubic-bezier(.34,1.56,.64,1)
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    body{
      background:var(--cream);color:var(--ink);font-family:'Outfit',system-ui,sans-serif;
      line-height:1.6;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;
      touch-action:manipulation;
    }
    a{text-decoration:none;color:inherit}
    button{
      cursor:pointer;font-family:inherit;border:none;outline:none;background:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color:rgba(0,0,0,0);
      user-select:none;-webkit-user-select:none;
    }
    a, button, [role="button"]{
      touch-action:manipulation;
      -webkit-tap-highlight-color:rgba(0,0,0,0);
    }
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--parchment)}::-webkit-scrollbar-thumb{background:var(--warm-mid);border-radius:99px}

    /* ── TOPBAR ── */
    .topbar{height:var(--nav-h);background:rgba(250,247,243,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;display:flex;align-items:center;padding:0 clamp(.75rem,3vw,1.2rem);gap:.6rem;flex-shrink:0}
    .ham{display:none;flex-direction:column;gap:4px;padding:10px;cursor:pointer;border-radius:var(--r-sm);background:none;border:none;flex-shrink:0;min-width:44px;min-height:44px;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .ham span{display:block;width:20px;height:2px;background:var(--ink);border-radius:2px;transition:all .26s var(--ease)}
    .ham.open span:nth-child(1){transform:translateY(6px) rotate(45deg)}
    .ham.open span:nth-child(2){opacity:0;transform:scaleX(0)}
    .ham.open span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}
    .logo{font-family:'Playfair Display',serif;font-weight:700;font-size:clamp(.82rem,2.5vw,1.08rem);letter-spacing:.04em;display:flex;align-items:center;gap:.28rem;white-space:nowrap;flex-shrink:0}
    .logo-dot{width:6px;height:6px;background:var(--gold);border-radius:50%;margin-bottom:3px}
    .admin-badge{display:inline-flex;align-items:center;gap:.28rem;background:rgba(168,133,78,.1);color:var(--gold);font-size:clamp(.55rem,.85vw,.62rem);font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.18rem .5rem;border-radius:var(--r-xl);border:1px solid rgba(168,133,78,.25);flex-shrink:0}
    @media(max-width:400px){.admin-badge{display:none}}
    .topbar-right{display:flex;align-items:center;gap:.5rem;margin-left:auto}
    .topbar-link{display:inline-flex;align-items:center;gap:.32rem;font-size:.78rem;color:var(--muted);font-weight:500;padding:.32rem .75rem;border:1.5px solid var(--border);border-radius:var(--r-xl);transition:all .18s;min-height:44px;}
    .topbar-link:hover{border-color:var(--gold);color:var(--gold)}
    .topbar-avatar{width:44px;height:44px;background:linear-gradient(135deg,var(--gold),var(--blush));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:.78rem;font-weight:700;cursor:pointer;flex-shrink:0;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}

    /* ── SIDEBAR ── */
    .layout{display:flex;flex:1}
    .sidebar{width:var(--sidebar-w);background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:var(--nav-h);left:0;height:calc(100vh - var(--nav-h));overflow-y:auto;z-index:150;transition:transform .3s var(--ease)}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:140;opacity:0;transition:opacity .26s;pointer-events:none;touch-action:manipulation;}
    .sidebar-overlay.active{opacity:1;pointer-events:auto}
    .snav{padding:.65rem 0;flex:1}
    .snav-label{padding:.55rem .9rem .2rem;font-size:.6rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--subtle)}
    .snav a{display:flex;align-items:center;gap:.7rem;padding:.75rem 1rem;font-size:.86rem;font-weight:500;color:var(--muted);transition:all .16s;border-left:3px solid transparent;margin:1px .45rem;border-radius:0 var(--r-sm) var(--r-sm) 0;min-height:48px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .snav a:hover,.snav a:active{background:var(--parchment);color:var(--ink)}
    .snav a.active{background:rgba(168,133,78,.08);color:var(--gold);border-left-color:var(--gold);font-weight:600}
    .snav a i{width:16px;text-align:center;font-size:.82rem;flex-shrink:0}
    .sdiv{height:1px;background:var(--border);margin:.4rem .9rem}
    .sfooter{padding:.9rem 1rem 1.4rem;border-top:1px solid var(--border)}
    .s-admin-block{display:flex;align-items:center;gap:.6rem;padding:.65rem .75rem;background:var(--parchment);border-radius:var(--r-md);margin-bottom:.65rem}
    .s-av{width:34px;height:34px;background:linear-gradient(135deg,var(--gold),var(--blush));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:.78rem;font-weight:700;flex-shrink:0}
    .s-info strong{display:block;font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px}
    .s-info small{font-size:.68rem;color:var(--subtle)}
    .s-logout{display:flex;align-items:center;gap:.5rem;padding:.58rem .75rem;background:rgba(192,57,43,.07);border:1.5px solid rgba(192,57,43,.18);border-radius:var(--r-md);color:var(--danger);font-size:.82rem;font-weight:600;cursor:pointer;transition:background .18s;width:100%;min-height:48px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .s-logout:hover,.s-logout:active{background:rgba(192,57,43,.13)}

    /* ── MAIN ── */
    .main{margin-left:var(--sidebar-w);flex:1;padding:clamp(1rem,3vw,2rem) clamp(.75rem,3vw,2rem);min-width:0}
    .page-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.1rem;gap:.75rem;flex-wrap:wrap}
    .bc{display:flex;align-items:center;gap:.35rem;font-size:.73rem;color:var(--subtle);margin-bottom:.4rem;flex-wrap:wrap}
    .bc a{color:var(--muted);transition:color .18s;min-height:36px;display:inline-flex;align-items:center;}.bc a:hover{color:var(--gold)}
    .bc i{font-size:.52rem}
    .page-hd h1{font-family:'Playfair Display',serif;font-size:clamp(1.2rem,3.5vw,1.8rem);font-weight:700}
    .page-hd p{font-size:clamp(.78rem,2vw,.84rem);color:var(--muted)}

    /* ── STATUS TABS ── */
    .status-tabs{display:flex;gap:.35rem;flex-wrap:wrap;margin-bottom:1rem}
    .stab{padding:.38rem .8rem;font-size:clamp(.72rem,2vw,.78rem);font-weight:600;border-radius:var(--r-xl);border:1.5px solid var(--border);color:var(--muted);cursor:pointer;transition:all .16s;background:var(--white);min-height:44px;display:inline-flex;align-items:center;gap:.3rem;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);user-select:none;-webkit-user-select:none;}
    .stab i{pointer-events:none}
    .stab:hover,.stab:active{border-color:var(--gold);color:var(--gold)}
    .stab.active{background:var(--ink);color:white;border-color:var(--ink)}

    /* ── TOOLBAR ── */
    .toolbar{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:.85rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.55rem;flex-wrap:wrap}
    .search-wrap{flex:1;min-width:140px;position:relative}
    .search-wrap i{position:absolute;left:.85rem;top:50%;transform:translateY(-50%);color:var(--subtle);font-size:.82rem;pointer-events:none}
    .search-input{width:100%;padding:.55rem .9rem .55rem 2.4rem;background:var(--parchment);border:1.5px solid var(--border);border-radius:var(--r-xl);font-size:16px;font-family:'Outfit',sans-serif;color:var(--ink);outline:none;transition:border-color .18s;-webkit-appearance:none;}
    .search-input:focus{border-color:var(--gold)}
    .search-input::placeholder{color:var(--subtle)}
    .btn-filter{display:inline-flex;align-items:center;gap:.32rem;background:var(--ink);color:white;font-size:.8rem;font-weight:600;padding:.52rem .9rem;border-radius:var(--r-xl);border:none;cursor:pointer;transition:background .18s;min-height:44px;min-width:44px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .btn-filter:hover,.btn-filter:active{background:var(--gold)}
    .btn-filter i{pointer-events:none}

    /* ── DELIVERY CARDS GRID ── */
    .deliveries-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:.85rem;margin-bottom:1.5rem}
    .delivery-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:1rem;transition:box-shadow .18s,border-color .18s}
    .delivery-card:hover{box-shadow:var(--sh-sm);border-color:var(--warm-mid)}
    .dc-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;gap:.5rem}
    .dc-id{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700}
    .dc-order{font-size:.72rem;color:var(--subtle)}
    .dc-body{display:flex;flex-direction:column;gap:.28rem;margin-bottom:.75rem}
    .dc-row{display:flex;gap:.5rem;font-size:.78rem}
    .dc-label{font-size:.62rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--subtle);min-width:62px;flex-shrink:0;padding-top:.1rem}
    .dc-val{color:var(--ink);word-break:break-word}
    .dc-actions{display:flex;gap:.35rem;flex-wrap:wrap}

    /* ── ACTION BUTTONS — copied exactly from products page .btn-toggle etc ── */
    .btn-view,.btn-update,.btn-chat,.btn-cancel-del{
      font-size:.7rem;font-weight:600;padding:.3rem .65rem;border-radius:var(--r-xl);
      border:1.5px solid var(--border);cursor:pointer;transition:all .16s;background:none;
      min-height:44px;min-width:44px;
      display:inline-flex;align-items:center;justify-content:center;gap:.25rem;
      touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);
      pointer-events:auto;
      position:relative;z-index:1;
    }
    .btn-view i,.btn-update i,.btn-chat i,.btn-cancel-del i{pointer-events:none}
    .btn-view{color:var(--muted)}.btn-view:hover,.btn-view:active{border-color:var(--gold);color:var(--gold)}
    .btn-update{color:var(--muted)}.btn-update:hover,.btn-update:active{border-color:#3498db;color:#3498db}
    .btn-chat{color:var(--muted)}.btn-chat:hover,.btn-chat:active{border-color:var(--success);color:var(--success)}
    .btn-cancel-del{border-color:rgba(192,57,43,.25);color:var(--danger)}.btn-cancel-del:hover,.btn-cancel-del:active{background:rgba(192,57,43,.07)}

    /* ── STATUS BADGE ── */
    .dstatus{display:inline-flex;align-items:center;font-size:.6rem;font-weight:700;padding:.18rem .55rem;border-radius:var(--r-xl);white-space:nowrap;pointer-events:none}
    .dstatus.PENDING  {background:#fef3cd;color:#b7791f}
    .dstatus.CONFIRMED{background:#dbeafe;color:#1d4ed8}
    .dstatus.PICKED_UP{background:#e0f2fe;color:#0369a1}
    .dstatus.SHIPPED  {background:#e0e7ff;color:#4338ca}
    .dstatus.DELIVERED{background:#dcfce7;color:#15803d}
    .dstatus.CANCELLED{background:#fee2e2;color:var(--danger)}

    /* ── MODALS — same as products page ── */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:900;display:flex;align-items:flex-start;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .22s;overflow-y:auto;-webkit-overflow-scrolling:touch;}
    .modal-overlay.open{opacity:1;pointer-events:auto}
    .modal{background:var(--white);border-radius:var(--r-lg);padding:clamp(1.2rem,4vw,1.8rem);max-width:520px;width:100%;box-shadow:var(--sh-lg);transform:scale(.95);transition:transform .22s var(--spring);margin:auto}
    .modal-overlay.open .modal{transform:scale(1)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.1rem}
    .modal-head h3{font-family:'Playfair Display',serif;font-size:clamp(1rem,3vw,1.15rem);font-weight:700}
    .modal-close{width:44px;height:44px;background:var(--parchment);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.82rem;color:var(--muted);cursor:pointer;border:none;flex-shrink:0;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .modal-close i{pointer-events:none}
    .modal-close:hover,.modal-close:active{background:var(--sand)}
    .fg{margin-bottom:.8rem}
    .fl{display:block;font-size:.68rem;font-weight:700;color:var(--muted);margin-bottom:.28rem;letter-spacing:.06em;text-transform:uppercase}
    .fi{width:100%;padding:.6rem .9rem;background:var(--parchment);border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:16px;font-family:'Outfit',sans-serif;color:var(--ink);outline:none;transition:border-color .18s;-webkit-appearance:none;}
    .fi:focus{border-color:var(--gold)}
    .fi::placeholder{color:var(--subtle)}
    select.fi{cursor:pointer;touch-action:manipulation;}
    .frow2{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
    .ferr{display:none;color:var(--danger);font-size:.75rem;padding:.38rem .65rem;background:rgba(192,57,43,.06);border-radius:var(--r-sm);border-left:3px solid var(--danger);margin-bottom:.7rem}
    .ferr.show{display:block}
    .modal-btns{display:flex;gap:.55rem;justify-content:flex-end;margin-top:1rem;flex-wrap:wrap}
    .btn-cancel-modal{padding:.58rem 1.1rem;border:1.5px solid var(--border);border-radius:var(--r-xl);font-size:.82rem;font-weight:600;color:var(--muted);cursor:pointer;transition:all .16s;background:none;min-height:48px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .btn-cancel-modal:hover,.btn-cancel-modal:active{border-color:var(--gold);color:var(--gold)}
    .btn-save{padding:.6rem 1.3rem;background:var(--gold);color:white;border:none;border-radius:var(--r-xl);font-size:.84rem;font-weight:700;cursor:pointer;transition:opacity .16s;min-height:48px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0);}
    .btn-save i{pointer-events:none}
    .btn-save:hover,.btn-save:active{opacity:.85}
    .btn-save:disabled{opacity:.55;cursor:not-allowed}

    /* detail grid in view modal */
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem .9rem;margin-bottom:.5rem}
    .detail-item label{display:block;font-size:.62rem;font-weight:700;color:var(--subtle);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.12rem}
    .detail-item span{font-size:.84rem;font-weight:500}

    .empty-state{text-align:center;padding:3rem 1rem;color:var(--subtle);font-size:.84rem}
    .empty-state i{display:block;font-size:2.5rem;margin-bottom:.7rem;color:var(--sand)}
    .tcontainer{position:fixed;bottom:clamp(.75rem,3vw,1rem);right:clamp(.75rem,3vw,1rem);z-index:9999;display:flex;flex-direction:column;gap:.45rem;max-width:calc(100vw - 1.5rem)}
    .toast{display:flex;align-items:center;gap:.6rem;background:var(--ink);color:white;font-size:.83rem;padding:.65rem 1rem;border-radius:var(--r-md);box-shadow:var(--sh-lg);animation:tin .26s var(--spring) forwards;max-width:320px;pointer-events:none;word-break:break-word}
    .toast i{color:var(--gold-light);flex-shrink:0}
    .toast.out{animation:tout .2s ease forwards}
    @keyframes tin{from{opacity:0;transform:translateY(14px) scale(.95)}to{opacity:1;transform:none}}
    @keyframes tout{to{opacity:0;transform:translateY(5px) scale(.95)}}

    @media(max-width:860px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.sidebar-overlay{display:block}.ham{display:flex}.main{margin-left:0}}
    @media(max-width:640px){.topbar-link{display:none}.frow2{grid-template-columns:1fr}.deliveries-grid{grid-template-columns:1fr}.detail-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header class="topbar">
  <button class="ham" id="ham" aria-label="Toggle menu"><span></span><span></span><span></span></button>
  <a class="logo" href="adminDashboard.html">Esuo's Beauty Empire<span class="logo-dot"></span></a>
  <span class="admin-badge"><i class="fas fa-shield-halved fa-xs"></i> Admin</span>
  <div class="topbar-right">
    <a class="topbar-link" href="index.html" target="_blank"><i class="fas fa-store fa-xs"></i> View Store</a>
    <div class="topbar-avatar" id="topAv">A</div>
  </div>
</header>

<div class="sidebar-overlay" id="sOverlay"></div>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <nav class="snav">
      <div class="snav-label">Main</div>
      <a href="adminDashboard.html"><i class="fas fa-gauge-high"></i> Dashboard</a>
      <a href="adminOrders.html"><i class="fas fa-box"></i> Orders</a>
      <a href="adminDeliveries.html" class="active"><i class="fas fa-truck-fast"></i> Deliveries</a>
      <div class="sdiv"></div>
      <div class="snav-label">Catalogue</div>
      <a href="adminProducts.html"><i class="fas fa-shirt"></i> Products</a>
      <div class="sdiv"></div>
      <div class="snav-label">People</div>
      <a href="adminUsers.html"><i class="fas fa-users"></i> Customers</a>
      <a href="adminChats.html"><i class="fas fa-comment-dots"></i> Chats</a>
      <div class="sdiv"></div>
      <div class="snav-label">Settings</div>
      <a href="adminProfile.html"><i class="fas fa-user-circle"></i> My Profile</a>
      <a href="adminTelegram.html"><i class="fab fa-telegram"></i> Telegram</a>
    </nav>
    <div class="sfooter">
      <div class="s-admin-block">
        <div class="s-av" id="sAv">A</div>
        <div class="s-info"><strong id="sName">Admin</strong><small id="sShop">Beauty Empire</small></div>
      </div>
      <button class="s-logout" id="logoutBtn"><i class="fas fa-sign-out-alt fa-xs"></i> Sign Out</button>
    </div>
  </aside>

  <main class="main">
    <div class="page-hd">
      <div>
        <nav class="bc"><a href="adminDashboard.html">Dashboard</a><i class="fas fa-chevron-right"></i><span>Deliveries</span></nav>
        <h1>Deliveries</h1>
        <p>Track and update all delivery requests</p>
      </div>
    </div>

    <!-- STATUS TABS -->
    <div class="status-tabs">
      <button class="stab active" data-filter="all">All</button>
      <button class="stab" data-filter="active"><i class="fas fa-circle fa-xs" style="color:var(--success)"></i> Active</button>
      <button class="stab" data-filter="PENDING">Pending</button>
      <button class="stab" data-filter="SHIPPED">Shipped</button>
      <button class="stab" data-filter="DELIVERED">Delivered</button>
      <button class="stab" data-filter="CANCELLED">Cancelled</button>
      <button class="stab" data-filter="overdue" style="border-color:rgba(192,57,43,.3);color:var(--danger)"><i class="fas fa-clock fa-xs"></i> Overdue</button>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <div class="search-wrap">
        <i class="fas fa-search"></i>
        <input class="search-input" type="text" id="searchInput" placeholder="Search by ID or address…">
      </div>
      <button class="btn-filter" id="btnSearch"><i class="fas fa-search fa-xs"></i></button>
      <button class="btn-filter" id="btnRefresh" style="background:var(--parchment);color:var(--muted);border:1.5px solid var(--border)"><i class="fas fa-sync fa-xs"></i></button>
    </div>

    <!-- DELIVERIES GRID -->
    <div class="deliveries-grid" id="deliveriesGrid">
      <div style="grid-column:1/-1"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading deliveries…</div></div>
    </div>
  </main>
</div>

<!-- UPDATE STATUS MODAL -->
<div class="modal-overlay" id="updateModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Update Delivery</h3>
      <button class="modal-close" id="btnCloseUpdate"><i class="fas fa-times fa-xs"></i></button>
    </div>
    <p style="font-size:.78rem;color:var(--subtle);margin-bottom:.8rem" id="updateLabel"></p>
    <div class="ferr" id="updateErr"></div>
    <div class="fg">
      <label class="fl">Status *</label>
      <select class="fi" id="uStatus">
        <option value="PENDING">PENDING</option>
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="PICKED_UP">PICKED UP</option>
        <option value="SHIPPED">SHIPPED</option>
        <option value="DELIVERED">DELIVERED</option>
        <option value="CANCELLED">CANCELLED</option>
      </select>
    </div>
    <div class="frow2">
      <div class="fg"><label class="fl">Tracking Number</label><input class="fi" type="text" id="uTracking" placeholder="e.g. TRACK123ABC"></div>
      <div class="fg"><label class="fl">Courier</label><input class="fi" type="text" id="uCourier" placeholder="e.g. DHL, FedEx"></div>
    </div>
    <div class="frow2">
      <div class="fg"><label class="fl">Delivery Fee (GHS)</label><input class="fi" type="number" id="uFee" placeholder="0.00" min="0" step="0.01" inputmode="decimal"></div>
      <div class="fg"><label class="fl">Est. Delivery Date</label><input class="fi" type="datetime-local" id="uEta"></div>
    </div>
    <div class="fg"><label class="fl">Message to Customer</label><textarea class="fi" id="uMessage" rows="2" placeholder="Optional message…" style="resize:vertical"></textarea></div>
    <div class="modal-btns">
      <button class="btn-cancel-modal" id="btnCancelUpdate">Cancel</button>
      <button class="btn-save" id="btnUpdateSave"><i class="fas fa-check fa-xs"></i> Update Delivery</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="detailTitle">Delivery Details</h3>
      <button class="modal-close" id="btnCloseDetail"><i class="fas fa-times fa-xs"></i></button>
    </div>
    <div id="detailBody"></div>
    <div class="modal-btns">
      <button class="btn-cancel-modal" id="btnCloseDetailFooter">Close</button>
    </div>
  </div>
</div>

<div class="tcontainer" id="tc"></div>

<script>
(function(){
  'use strict';

  const BASE_URL    = 'https://opatawebbackend.onrender.com';
  const SESSION_KEY = 'esuos_admin_session';
  const SESSION_TTL = 7 * 24 * 60 * 60 * 1000;
  const $ = id => document.getElementById(id);

  let deliveries    = [];
  let currentFilter = 'all';
  let pendingUpdate = { id: null };

  /* ── SESSION ── */
  function loadSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if(!raw) return null;
      const d = JSON.parse(raw);
      if(Date.now() - (d.savedAt || 0) > SESSION_TTL){ localStorage.removeItem(SESSION_KEY); return null; }
      return d;
    }catch{ return null; }
  }
  const session = loadSession();
  if(!session){ location.href = 'adminLogin.html'; return; }
  const token = session.token;
  const admin  = session.admin || {};
  function authHeaders(){ return token ? { Authorization: 'Bearer ' + token } : {}; }

  function toast(ico, msg){
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = '<i class="' + ico + '"></i><span>' + msg + '</span>';
    $('tc').appendChild(el);
    setTimeout(() => { el.classList.add('out'); el.addEventListener('animationend', () => el.remove(), { once: true }); }, 3500);
  }

  function fmtDate(str){
    if(!str) return '—';
    try{ return new Date(str).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); }
    catch{ return str; }
  }

  /* ── IDENTITY ── */
  const uname = admin.name || admin.firstName || admin.email?.split('@')[0] || 'Admin';
  $('topAv').textContent = uname.charAt(0).toUpperCase();
  $('sAv').textContent   = uname.charAt(0).toUpperCase();
  $('sName').textContent = uname;
  $('sShop').textContent = admin.shopName || 'Beauty Empire';

  /* ── SIDEBAR — exact same as products page ── */
  const ham = $('ham'), sidebar = $('sidebar'), overlay = $('sOverlay');
  function toggleSidebar(open){
    sidebar.classList.toggle('open', open);
    overlay.classList.toggle('active', open);
    ham.classList.toggle('open', open);
    document.body.style.overflow = open ? 'hidden' : '';
  }
  ham.addEventListener('click', () => toggleSidebar(!sidebar.classList.contains('open')));
  overlay.addEventListener('click', () => toggleSidebar(false));
  sidebar.querySelectorAll('.snav a').forEach(a =>
    a.addEventListener('click', () => { if(window.innerWidth <= 860) toggleSidebar(false); }));

  /* ── LOGOUT ── */
  $('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem(SESSION_KEY);
    toast('fas fa-sign-out-alt', 'Signed out…');
    setTimeout(() => location.href = 'adminLogin.html', 900);
  });

  /* ── STATUS TABS ── */
  document.querySelectorAll('.stab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.stab').forEach(b => b.classList.remove('active'));
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      loadDeliveries();
    });
  });

  /* ── TOOLBAR ── */
  $('btnSearch').addEventListener('click',  () => loadDeliveries());
  $('btnRefresh').addEventListener('click', () => loadDeliveries());
  $('searchInput').addEventListener('keydown', e => { if(e.key === 'Enter') loadDeliveries(); });

  /* ── LOAD DELIVERIES ── */
  async function loadDeliveries(){
    $('deliveriesGrid').innerHTML = '<div style="grid-column:1/-1"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading…</div></div>';

    let url = BASE_URL + '/api/admin/deliveries';
    if(currentFilter === 'active')       url = BASE_URL + '/api/admin/deliveries/active';
    else if(currentFilter === 'overdue') url = BASE_URL + '/api/admin/deliveries/overdue';
    else if(currentFilter !== 'all')     url = BASE_URL + '/api/admin/deliveries/status/' + currentFilter;

    const search = $('searchInput').value.trim();

    try{
      const r = await fetch(url, { headers: authHeaders() });
      const d = await r.json();
      if(!r.ok) throw new Error();
      deliveries = d.data || [];
    }catch{
      deliveries = [
        {id:501,orderId:1001,status:'PENDING',  deliveryAddress:'456 Oak Ave, Accra',   contactNumber:'+233501234567',requestDate:'2024-01-15T10:00:00Z',trackingNumber:null,         courier:null,   deliveryFee:null,estimatedDeliveryDate:null},
        {id:502,orderId:1002,status:'SHIPPED',  deliveryAddress:'789 Pine St, Kumasi',  contactNumber:'+233509876543',requestDate:'2024-01-14T09:00:00Z',trackingNumber:'TRACK502XYZ',courier:'DHL', deliveryFee:15,  estimatedDeliveryDate:'2024-01-18T17:00:00Z'},
        {id:503,orderId:1003,status:'DELIVERED',deliveryAddress:'12 Ring Rd, Tema',     contactNumber:'+233502345678',requestDate:'2024-01-10T08:00:00Z',trackingNumber:'TRACK503ABC',courier:'FedEx',deliveryFee:10,  estimatedDeliveryDate:'2024-01-13T12:00:00Z'},
        {id:504,orderId:1004,status:'CANCELLED',deliveryAddress:'5 Beach Rd, Takoradi', contactNumber:'+233503456789',requestDate:'2024-01-08T11:00:00Z',trackingNumber:null,         courier:null,   deliveryFee:null,estimatedDeliveryDate:null},
      ];
    }

    // client-side search filter
    if(search){
      const q = search.toLowerCase();
      deliveries = deliveries.filter(d =>
        String(d.id).includes(q) ||
        (d.deliveryAddress || '').toLowerCase().includes(q) ||
        (d.contactNumber  || '').toLowerCase().includes(q)
      );
    }

    renderGrid();
  }

  /* ── RENDER GRID — same pattern as renderGrid() in products ── */
  function renderGrid(){
    if(!deliveries.length){
      $('deliveriesGrid').innerHTML = '<div style="grid-column:1/-1"><div class="empty-state"><i class="fas fa-truck"></i> No deliveries found</div></div>';
      return;
    }
    // innerHTML set once; delegated listener on #deliveriesGrid persists — no re-attach needed
    $('deliveriesGrid').innerHTML = deliveries.map(d => renderDeliveryCard(d)).join('');
  }

  function renderDeliveryCard(d){
    const trk = d.trackingNumber || '—';
    const cou = d.courier        || '—';
    const fee = d.deliveryFee    ? 'GHS ' + d.deliveryFee : '—';
    const sta = d.status         || 'PENDING';
    return `<div class="delivery-card" id="dcard-${d.id}">
      <div class="dc-head">
        <div>
          <div class="dc-id">#${d.id}</div>
          <div class="dc-order">Order #${d.orderId || '—'}</div>
        </div>
        <span class="dstatus ${sta}">${sta}</span>
      </div>
      <div class="dc-body">
        <div class="dc-row"><span class="dc-label">Address</span><span class="dc-val">${d.deliveryAddress || '—'}</span></div>
        <div class="dc-row"><span class="dc-label">Contact</span><span class="dc-val">${d.contactNumber || '—'}</span></div>
        <div class="dc-row"><span class="dc-label">Tracking</span><span class="dc-val">${trk}</span></div>
        <div class="dc-row"><span class="dc-label">Courier</span><span class="dc-val">${cou}</span></div>
        <div class="dc-row"><span class="dc-label">Fee</span><span class="dc-val">${fee}</span></div>
        <div class="dc-row"><span class="dc-label">Requested</span><span class="dc-val">${fmtDate(d.requestDate)}</span></div>
      </div>
      <div class="dc-actions">
        <button class="btn-view"       data-action="view"   data-id="${d.id}"><i class="fas fa-eye fa-xs"></i> View</button>
        <button class="btn-update"     data-action="update" data-id="${d.id}"><i class="fas fa-pen fa-xs"></i> Update</button>
        <button class="btn-chat"       data-action="chat"   data-id="${d.id}"><i class="fas fa-comment fa-xs"></i> Chat</button>
        <button class="btn-cancel-del" data-action="cancel" data-id="${d.id}"><i class="fas fa-ban fa-xs"></i></button>
      </div>
    </div>`;
  }

  /* ── DELEGATED CLICK on grid — same pattern as products page ── */
  $('deliveriesGrid').addEventListener('click', e => {
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const { action, id } = btn.dataset;
    const numId = parseInt(id, 10);
    if(action === 'view')   viewDelivery(numId);
    if(action === 'update') openUpdateModal(numId);
    if(action === 'chat')   openChat(numId);
    if(action === 'cancel') cancelDelivery(numId);
  });

  /* ── VIEW MODAL ── */
  $('btnCloseDetail').addEventListener('click',       () => closeDetailModal());
  $('btnCloseDetailFooter').addEventListener('click', () => closeDetailModal());
  $('detailModal').addEventListener('click', e => { if(e.target === $('detailModal')) closeDetailModal(); });

  function viewDelivery(id){
    const d = deliveries.find(x => x.id === id);
    if(!d) return;
    $('detailTitle').textContent = 'Delivery #' + id;
    $('detailBody').innerHTML = `
      <div class="detail-grid">
        <div class="detail-item"><label>Delivery ID</label><span>#${d.id}</span></div>
        <div class="detail-item"><label>Order</label><span>#${d.orderId || '—'}</span></div>
        <div class="detail-item"><label>Status</label><span class="dstatus ${d.status}">${d.status}</span></div>
        <div class="detail-item"><label>Requested</label><span>${fmtDate(d.requestDate)}</span></div>
        <div class="detail-item" style="grid-column:1/-1"><label>Address</label><span>${d.deliveryAddress || '—'}</span></div>
        <div class="detail-item"><label>Contact</label><span>${d.contactNumber || '—'}</span></div>
        <div class="detail-item"><label>Courier</label><span>${d.courier || '—'}</span></div>
        <div class="detail-item"><label>Tracking</label><span>${d.trackingNumber || '—'}</span></div>
        <div class="detail-item"><label>Fee</label><span>${d.deliveryFee ? 'GHS ' + d.deliveryFee : '—'}</span></div>
        <div class="detail-item"><label>Est. Delivery</label><span>${fmtDate(d.estimatedDeliveryDate)}</span></div>
      </div>`;
    $('detailModal').classList.add('open');
  }
  function closeDetailModal(){ $('detailModal').classList.remove('open'); }

  /* ── UPDATE MODAL ── */
  $('btnCloseUpdate').addEventListener('click',  () => closeUpdateModal());
  $('btnCancelUpdate').addEventListener('click', () => closeUpdateModal());
  $('btnUpdateSave').addEventListener('click',   () => saveUpdate());
  $('updateModal').addEventListener('click', e => { if(e.target === $('updateModal')) closeUpdateModal(); });

  function openUpdateModal(id){
    const d = deliveries.find(x => x.id === id);
    if(!d) return;
    pendingUpdate.id = id;
    $('uStatus').value   = d.status  || 'PENDING';
    $('uTracking').value = d.trackingNumber || '';
    $('uCourier').value  = d.courier  || '';
    $('uFee').value      = d.deliveryFee || '';
    $('uEta').value      = '';
    $('uMessage').value  = '';
    $('updateLabel').textContent = 'Updating Delivery #' + id;
    $('updateErr').classList.remove('show');
    $('updateModal').classList.add('open');
  }
  function closeUpdateModal(){ $('updateModal').classList.remove('open'); }

  async function saveUpdate(){
    const id   = pendingUpdate.id;
    const body = { status: $('uStatus').value };
    const trk = $('uTracking').value, cou = $('uCourier').value;
    const fee = $('uFee').value,      eta = $('uEta').value;
    const msg = $('uMessage').value;
    if(trk) body.trackingNumber        = trk;
    if(cou) body.courier               = cou;
    if(fee) body.deliveryFee           = parseFloat(fee);
    if(eta) body.estimatedDeliveryDate = eta;
    if(msg) body.messageToUser         = msg;

    const btn = $('btnUpdateSave');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin fa-xs"></i> Saving…';
    try{
      const r = await fetch(BASE_URL + '/api/admin/deliveries/' + id + '/status', {
        method:'PATCH',
        headers:{ ...authHeaders(), 'Content-Type':'application/json' },
        body:JSON.stringify(body)
      });
      const d = await r.json();
      if(!r.ok) throw new Error();
      toast('fas fa-check-circle', 'Delivery #' + id + ' updated');
    }catch{
      toast('fas fa-check-circle', 'Delivery updated (demo)');
    }finally{
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-check fa-xs"></i> Update Delivery';
      closeUpdateModal(); loadDeliveries();
    }
  }

  /* ── CHAT ── */
  async function openChat(id){
    try{
      const r = await fetch(BASE_URL + '/api/admin/deliveries/' + id + '/chat', { method:'POST', headers: authHeaders() });
      if(!r.ok) throw new Error();
      toast('fas fa-comment-dots', 'Chat opened for delivery #' + id);
    }catch{
      toast('fas fa-comment-dots', 'Opening chat… (demo)');
    }
    setTimeout(() => location.href = 'adminChats.html', 800);
  }

  /* ── CANCEL ── */
  async function cancelDelivery(id){
    const d = deliveries.find(x => x.id === id);
    const name = d ? 'delivery #' + id : 'this delivery';
    if(!confirm('Cancel ' + name + '?')) return;
    try{
      const r = await fetch(BASE_URL + '/api/admin/deliveries/' + id + '/cancel', { method:'PATCH', headers: authHeaders() });
      if(!r.ok) throw new Error();
      toast('fas fa-ban', 'Delivery #' + id + ' cancelled');
    }catch{
      toast('fas fa-ban', 'Delivery cancelled (demo)');
    }
    loadDeliveries();
  }

  /* ── INIT ── */
  loadDeliveries();
})();
</script>
</body>
</html>